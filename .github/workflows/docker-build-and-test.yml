name: Docker Build & Test

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docker-build-and-test:
    name: Build Docker Image and Run CLI Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -f musicdl.Dockerfile -t musicdl:test .

      - name: Set image tag variable
        run: echo "IMAGE_TAG=musicdl:test" >> $GITHUB_ENV

      - name: Smoke Test 1 - Directory and binary
        run: |
          echo "Testing directory and binary..."
          docker run --rm --entrypoint test "$IMAGE_TAG" -d /download && echo "✓ /download exists" || (echo "✗ /download missing" && exit 1)
          docker run --rm --entrypoint test "$IMAGE_TAG" -f /usr/local/bin/musicdl && echo "✓ Go binary exists" || (echo "✗ Go binary not found" && exit 1)
          docker run --rm --entrypoint test "$IMAGE_TAG" -x /usr/local/bin/musicdl && echo "✓ Go binary is executable" || (echo "✗ Go binary not executable" && exit 1)

      - name: Smoke Test 2 - CLI commands
        run: |
          echo "Testing CLI commands..."
          # Usage (no args)
          docker run --rm --entrypoint /usr/local/bin/musicdl "$IMAGE_TAG" 2>&1 | grep -q "plan" && echo "✓ Usage lists plan" || (echo "✗ Usage missing plan" && exit 1)
          docker run --rm --entrypoint /usr/local/bin/musicdl "$IMAGE_TAG" 2>&1 | grep -q "download" && echo "✓ Usage lists download" || (echo "✗ Usage missing download" && exit 1)
          # Version
          VERSION_OUTPUT=$(docker run --rm --entrypoint /usr/local/bin/musicdl "$IMAGE_TAG" version 2>&1) || (echo "✗ Version command failed" && exit 1)
          if echo "$VERSION_OUTPUT" | grep -qE "musicdl version (v?[0-9]+\.[0-9]+\.[0-9]+|[a-f0-9]{7,}|dev)"; then
            echo "✓ Version command returns valid version: $VERSION_OUTPUT"
          else
            echo "✗ Version command returned invalid output: $VERSION_OUTPUT"
            exit 1
          fi

      - name: Smoke Test 3 - System dependencies
        run: |
          echo "Testing system dependencies..."
          docker run --rm --entrypoint ffmpeg "$IMAGE_TAG" -version > /dev/null 2>&1 && echo "✓ ffmpeg is available" || (echo "✗ ffmpeg not found" && exit 1)

      - name: Functional Test - CLI exit codes
        run: |
          echo "Testing CLI exit codes..."
          # plan with missing config -> exit 1 (config error)
          EXIT_CODE=$(docker run --rm --entrypoint /usr/local/bin/musicdl -w /download "$IMAGE_TAG" plan /download/nonexistent.yaml 2>/dev/null; echo $?)
          if [ "$EXIT_CODE" = "1" ]; then
            echo "✓ plan with missing config exits 1"
          else
            echo "✗ plan with missing config expected exit 1, got $EXIT_CODE"
            exit 1
          fi
          # download with no plan file -> exit 2 (plan not found); need a valid config so hash can be computed
          printf '%s\n' \
            'version: "1.2"' \
            'download:' \
            '  client_id: "id"' \
            '  client_secret: "secret"' \
            '  output: "{title}.mp3"' > /tmp/test-config.yaml
          EXIT_CODE=$(docker run --rm --entrypoint /usr/local/bin/musicdl -w /download -v /tmp/test-config.yaml:/download/config.yaml:ro "$IMAGE_TAG" download /download/config.yaml 2>/dev/null; echo $?)
          if [ "$EXIT_CODE" = "2" ]; then
            echo "✓ download with no plan exits 2"
          else
            echo "✗ download with no plan expected exit 2, got $EXIT_CODE"
            exit 1
          fi
          echo "✓ All CLI exit code tests passed"
