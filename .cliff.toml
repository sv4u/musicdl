[changelog]
# Changelog header
header = """
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
"""

# Footer
footer = """
---
{% if previous.version %}**Full Changelog**: https://github.com/sv4u/musicdl/compare/{{ previous.version }}...{{ version }}{% else %}**Full Changelog**: https://github.com/sv4u/musicdl/releases/tag/{{ version }}{% endif %}
"""

# Template for changelog body
body = """
{% if version %}\
## [{{ version }}](https://github.com/sv4u/musicdl/releases/tag/{{ version }}) - {{ timestamp | date(format="%Y-%m-%d") }}

{% else %}\
## [Unreleased]

{% endif %}\
{% set breaking = commits | filter(attribute="breaking", value=true) %}
{% if breaking | length > 0 %}
### ⚠️ Breaking Changes

{% for commit in breaking %}
- {% if commit.scope %}**{{ commit.scope }}**: {% endif %}{{ commit.message | upper_first }}{% if commit.links %} ({{ commit.links | join(sep=", ") }}){% endif %}
{% endfor %}

{% endif %}\
{% set non_breaking_commits = commits | filter(attribute="breaking", value=false) %}
{% for group, commits in non_breaking_commits | group_by(attribute="group") %}
### {{ group | upper_first }}

{% for commit in commits %}
- {% if commit.scope %}**{{ commit.scope }}**: {% endif %}{{ commit.message | upper_first }}{% if commit.links %} ({{ commit.links | join(sep=", ") }}){% endif %}
{% endfor %}

{% endfor %}
"""

# Git configuration
[git]
conventional_commits = true
filter_unconventional = true
split_commits = false
commit_parsers = [
    # Breaking changes (must come first)
    { message = "^feat!", group = "Breaking Changes", breaking = true },
    { message = "^fix!", group = "Breaking Changes", breaking = true },
    { message = "BREAKING CHANGE", group = "Breaking Changes", breaking = true },
    
    # Features by scope
    { message = "^feat\\(config\\)", group = "Features", scope = "Configuration" },
    { message = "^feat\\(downloader\\)", group = "Features", scope = "Downloader" },
    { message = "^feat\\(docker\\)", group = "Features", scope = "Docker" },
    { message = "^feat\\(ci\\)", group = "Features", scope = "CI/CD" },
    { message = "^feat\\(spotify\\)", group = "Features", scope = "Spotify" },
    { message = "^feat\\(cache\\)", group = "Features", scope = "Cache" },
    { message = "^feat\\(plan\\)", group = "Features", scope = "Plan Architecture" },
    { message = "^feat", group = "Features", default_scope = "General" },
    
    # Bug fixes by scope
    { message = "^fix\\(config\\)", group = "Bug Fixes", scope = "Configuration" },
    { message = "^fix\\(downloader\\)", group = "Bug Fixes", scope = "Downloader" },
    { message = "^fix\\(docker\\)", group = "Bug Fixes", scope = "Docker" },
    { message = "^fix\\(ci\\)", group = "Bug Fixes", scope = "CI/CD" },
    { message = "^fix\\(spotify\\)", group = "Bug Fixes", scope = "Spotify" },
    { message = "^fix\\(cache\\)", group = "Bug Fixes", scope = "Cache" },
    { message = "^fix\\(plan\\)", group = "Bug Fixes", scope = "Plan Architecture" },
    { message = "^fix\\(tests\\)", group = "Bug Fixes", scope = "Tests" },
    { message = "^fix\\(rate-limiter\\)", group = "Bug Fixes", scope = "Rate Limiter" },
    
    # Security fixes (must come before catch-all ^fix pattern)
    { message = "^fix\\(security\\)", group = "Security", scope = "Security" },
    
    { message = "^fix", group = "Bug Fixes", default_scope = "General" },
    
    # Documentation
    { message = "^docs", group = "Documentation", default_scope = "General" },
    
    # Refactoring
    { message = "^refactor", group = "Refactoring", default_scope = "General" },
    
    # Performance
    { message = "^perf", group = "Performance", default_scope = "General" },
    
    # Tests
    { message = "^test", group = "Tests", default_scope = "General" },
    
    # CI/CD
    { message = "^ci", group = "CI/CD", default_scope = "General" },
    
    # Build
    { message = "^build", group = "Build", default_scope = "General" },
    
    # Style
    { message = "^style", group = "Style", default_scope = "General" },
    
    # Chores
    { message = "^chore", group = "Chores", default_scope = "General" },
]

# Link parsing (for PR/issue references)
link_parsers = [
    # Match PR references: (PR #123) or bare (#123) - bare references default to PRs
    # Use non-capturing groups for prefixes, single capture group for number
    { pattern = '\((?:PR )?#(\d+)\)', href = "https://github.com/sv4u/musicdl/pull/$1", text = "#$1" },
    # Match issue references: (issue #456) - requires explicit "issue" prefix
    # This pattern only matches when "issue" is explicitly present to avoid conflicts with PR pattern
    { pattern = '\(issue #(\d+)\)', href = "https://github.com/sv4u/musicdl/issues/$1", text = "#$1" },
]

# Tag pattern (must be directly under [git] section, not nested)
tag_pattern = '^v(.*)$'

